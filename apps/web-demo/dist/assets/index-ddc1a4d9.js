(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();class tt{constructor({id:e,name:t,color:a,priority:s=0,behaviors:r=[]}){this.id=e,this.name=t,this.color=a,this.priority=s,this.behaviors=r}update(e,t,a,s){for(const r of this.behaviors)if(r(this,e,t,a,s))return}}const R=0,k=1,v=2,U=3,C=4,_=5,S=6,W=7,E=8,N=9,V=10,ot=11,K=12,et=13;function rt(o,e,t,a,s){const{width:r,height:c}=a,g=Math.floor(o/r),u=o%r;if(g<c-1){const l=o+r,h=t[l];if(s.includes(h))return t[l]=e[o],t[o]=h,!0}const i=Math.random()<.5?-1:1,n=o+r+i;if(g<c-1&&u+i>=0&&u+i<r&&s.includes(t[n])){const l=t[n];return t[n]=e[o],t[o]=l,!0}return!1}function st(o,e,t,a,s){const{width:r,height:c}=a,g=Math.floor(o/r),u=o%r;if(g<c-1){const y=o+r,A=t[y];if(s.includes(A))return t[y]=e[o],t[o]=A,!0}const i=Math.random()<.5?-1:1,n=o+r+i;if(g<c-1&&u+i>=0&&u+i<r&&s.includes(t[n])){const y=t[n];return t[n]=e[o],t[o]=y,!0}const l=o+r-i;if(g<c-1&&u-i>=0&&u-i<r&&s.includes(t[l])){const y=t[l];return t[l]=e[o],t[o]=y,!0}const h=o-1,p=o+1,f=u>0&&s.includes(t[h]),b=u<r-1&&s.includes(t[p]);if(f&&b){if(Math.random()<.5){const y=t[h];t[h]=e[o],t[o]=y}else{const y=t[p];t[p]=e[o],t[o]=y}return!0}if(f){const y=t[h];return t[h]=e[o],t[o]=y,!0}if(b){const y=t[p];return t[p]=e[o],t[o]=y,!0}return!1}function ct(o,e,t,a,s){const{width:r,height:c}=a,g=Math.floor(o/r),u=o%r;if(g>0){const b=o-r,y=t[b];if(s.includes(y))return t[b]=e[o],t[o]=y,!0}const i=Math.random()<.5?-1:1,n=o-r+i;if(g>0&&u+i>=0&&u+i<r&&s.includes(t[n])){const b=t[n];return t[n]=e[o],t[o]=b,!0}const l=o-1,h=o+1,p=u>0&&s.includes(t[l]),f=u<r-1&&s.includes(t[h]);if(p&&f){if(Math.random()<.5){const b=t[l];t[l]=e[o],t[o]=b}else{const b=t[h];t[h]=e[o],t[o]=b}return!0}if(p){const b=t[l];return t[l]=e[o],t[o]=b,!0}if(f){const b=t[h];return t[h]=e[o],t[o]=b,!0}return!1}function J(o){return(e,t,a,s,r)=>rt(t,a,s,r,o.allowed)}function D(o){return(e,t,a,s,r)=>st(t,a,s,r,o.allowed)}function Q(o){return(e,t,a,s,r)=>ct(t,a,s,r,o.allowed)}function nt(o){return(e,t,a,s,r)=>{const{width:c,height:g}=r,u=Math.floor(t/c),i=t%c;return u>0&&o.targets.includes(a[t-c])&&Math.random()<o.prob&&(s[t-c]=a[t]),u<g-1&&o.targets.includes(a[t+c])&&Math.random()<o.prob&&(s[t+c]=a[t]),i>0&&o.targets.includes(a[t-1])&&Math.random()<o.prob&&(s[t-1]=a[t]),i<c-1&&o.targets.includes(a[t+1])&&Math.random()<o.prob&&(s[t+1]=a[t]),!1}}function at(o){return(e,t,a,s,r)=>{const{width:c}=r;return Math.floor(t/c)>0&&Math.random()<o.prob&&s[t-c]===R&&(s[t-c]=W),!1}}function lt(o){return(e,t,a,s,r)=>{if(Math.random()<o.deathProb){const{width:c,height:g}=r,u=Math.floor(t/c),i=t%c;let n=0;for(let l=-1;l<=1;l++)for(let h=-1;h<=1;h++){if(h===0&&l===0)continue;const p=i+h,f=u+l;p>=0&&p<c&&f>=0&&f<g&&a[f*c+p]===S&&n++}return s[t]=n<o.ashThreshold?S:R,!0}return!1}}function Z(o){return(e,t,a,s)=>(Math.random()<o.prob&&(s[t]=typeof o.target=="function"?o.target():o.target),!1)}function it(o){return(e,t,a,s,r)=>{var n,l;const{width:c,height:g}=r,u=Math.floor(t/c),i=t%c;for(let h=-1;h<=1;h++)for(let p=-1;p<=1;p++){if(p===0&&h===0)continue;const f=i+p,b=u+h;if(f<0||f>=c||b<0||b>=g)continue;const y=b*c+f,A=a[y];if(!(A===e.id||(n=o.skip)!=null&&n.includes(A))&&Math.random()<o.spreadProb&&(s[y]=e.id,(l=o.solidTargets)!=null&&l.includes(A)))return s[t]=R,!0}return!1}}function ht(o,e,t){const{width:a,height:s}=t,r=5+Math.floor(Math.random()*5),c=3,g=.3,u=3,i=6,n=[];let l=o,h=e;for(let f=0;f<r&&!(h-1<0);f++)h--,n.push({x:l,y:h});const p=[];for(let f=1;f<n.length-1;f++)if(Math.random()<g){const b=n[f],y=Math.random()<.5?-1:1;p.push({x:b.x,y:b.y,dir:y,depth:1})}if(n.length){const f=n[n.length-1];p.push({x:f.x,y:f.y,dir:-1,depth:1}),p.push({x:f.x,y:f.y,dir:1,depth:1})}for(;p.length>0;){const f=p.pop(),b=u+Math.floor(Math.random()*(i-u));let y=f.x,A=f.y;for(let I=0;I<b&&(y+=f.dir,A-=1,!(y<0||y>=a||A<0));I++)if(f.depth<c&&Math.random()<g){const O=Math.random()<.5?-1:1;p.push({x:y,y:A,dir:O,depth:f.depth+1})}}}function Y(o){return(e,t,a,s)=>Math.random()<o.prob?(s[t]=o.target,!0):!1}function q(o){return(e,t,a,s,r)=>{const{width:c,height:g}=r,u=Math.floor(t/c),i=t%c,n=[];u>0&&n.push(t-c),u<g-1&&n.push(t+c),i>0&&n.push(t-1),i<c-1&&n.push(t+1);for(const l of n)if(o.triggerCells.includes(a[l])&&Math.random()<(o.prob??1))return s[t]=o.result,!0;return!1}}function ut(o){return(e,t,a,s,r)=>{const{width:c,height:g}=r,u=Math.floor(t/c),i=t%c,n=[];u>0&&n.push(t-c),u<g-1&&n.push(t+c),i>0&&n.push(t-1),i<c-1&&n.push(t+1);for(let l=n.length-1;l>0;l--){const h=Math.floor(Math.random()*(l+1));[n[l],n[h]]=[n[h],n[l]]}for(const l of n)if(o.triggerCells.includes(a[l])&&Math.random()<(o.prob??1))return s[l]=e.id,!0;return!1}}function ft(o){return(e,t,a,s,r)=>{const{width:c,height:g}=r,u=Math.floor(t/c),i=t%c,n=[];u>0&&n.push(t-c),u<g-1&&n.push(t+c),i>0&&n.push(t-1),i<c-1&&n.push(t+1);for(const l of n)if(o.triggerCells.includes(a[l]))return s[t]=o.result,o.action(i,u,r),!0;return!1}}function gt(o,e){const t=Math.sin(o*12.9898+e*78.233)*43758.5453;return t-Math.floor(t)}const mt={id:R,name:"Air",color:(o,e)=>"#222",priority:0,behaviors:[]},pt={id:k,name:"Sand",color:(o,e)=>"#c2b280",priority:1,behaviors:[J({allowed:[R,v,V,N]})]},yt={id:v,name:"Water",color:(o,e)=>{const t=performance.now(),a=152+20*Math.sin((o+e)/5+t/500);return`rgb(52,${Math.floor(a)},219)`},priority:2,behaviors:[D({allowed:[R]})]},bt={id:U,name:"Rock",color:(o,e)=>"#888888",priority:0,behaviors:[]},dt=.2,Mt=.001,Rt={id:C,name:"Plant",color:(o,e)=>"#2ecc71",priority:3,behaviors:[Y({target:E,prob:Mt}),ut({triggerCells:[v],prob:dt})]},At=.5,Et=.2,_t=.05,It=1,Tt=.1,vt={id:_,name:"Fire",color:(o,e)=>{const t=200+Math.random()*55,a=Math.random()*100,s=Math.random()*50;return`rgb(${t|0},${a|0},${s|0})`},priority:4,behaviors:[nt({targets:[C,E,N],prob:At}),at({prob:Et}),lt({deathProb:_t,ashThreshold:It}),Z({target:K,prob:Tt})]},Ct={id:S,name:"Ash",color:(o,e)=>"#95a5a6",priority:1,behaviors:[J({allowed:[R,v,W]})]},Nt=.02,Ot={id:W,name:"Smoke",color:(o,e)=>"#bdc3c7",priority:5,behaviors:[Y({target:R,prob:Nt}),Q({allowed:[R]})]},Bt={id:E,name:"Wood",color:(o,e)=>"#a0522d",priority:0,behaviors:[]},Lt=.02,Pt={id:N,name:"Oil",color:(o,e)=>"#333300",priority:2,behaviors:[q({triggerCells:[_],result:_,prob:Lt}),D({allowed:[R]})]},St=.02,Dt={id:V,name:"Acid",color:(o,e)=>"#00FF00",priority:2,behaviors:[it({skip:[R,_,k],solidTargets:[k,U,C,S,E],spreadProb:St}),D({allowed:[R]})]},Ft={id:ot,name:"Seed",color:(o,e)=>{const t=gt(o,e),a=Math.floor(139*(.8+.4*t)),s=Math.floor(69*(.8+.4*t)),r=Math.floor(19*(.8+.4*t));return`rgb(${a},${s},${r})`},priority:3,behaviors:[ft({triggerCells:[v],result:E,action:ht})]},Ht=.05,$t={id:K,name:"Cinder",color:(o,e)=>"#f39c12",priority:5,behaviors:[Q({allowed:[R]}),q({triggerCells:[C,E,N],result:_}),Y({target:R,prob:Ht})]},kt=1,Wt=.02,Kt={id:et,name:"Lava",color:(o,e)=>"#e74c3c",priority:2,behaviors:[D({allowed:[R]}),q({triggerCells:[C,E,N],result:_,prob:kt}),Z({target:()=>K,prob:Wt})]};class Yt{constructor(e){this.byId=new Map,this.byName=new Map;for(const t of e)this.byId.set(t.id,t),this.byName.set(t.name,t)}getById(e){return this.byId.get(e)}getByName(e){return this.byName.get(e)}getAll(){return Array.from(this.byId.values())}}const qt=[mt,pt,yt,bt,Rt,vt,Ct,Ot,Bt,Pt,Dt,Ft,$t,Kt],zt=qt.map(o=>new tt(o)),P=new Yt(zt),Xt=200,jt=150,T={width:Xt,height:jt};function Ut(o=!1){return{scanLeftToRight:!0,scanBottomToTop:!0,toggleScanDirection:o}}function j(o){return new Uint8Array(o.width*o.height)}function Vt(o){return[j(o),j(o)]}function Jt(o,e,t,a,s,r){const{width:c,height:g}=T;e.set(o);for(const u of a)for(let i=r.scanBottomToTop?g-1:0;r.scanBottomToTop?i>=0:i<g;i+=r.scanBottomToTop?-1:1)if(s){const n=Math.floor(Math.random()*c);for(let l=0;l<c;l++){const h=r.scanLeftToRight?(n+l)%c:(n-l+c)%c,p=i*c+h,f=t[o[p]];f.priority===u&&f.update(p,o,e,T)}}else if(r.scanLeftToRight)for(let n=0;n<c;n++){const l=i*c+n,h=t[o[l]];h.priority===u&&h.update(l,o,e,T)}else for(let n=c-1;n>=0;n--){const l=i*c+n,h=t[o[l]];h.priority===u&&h.update(l,o,e,T)}return r.toggleScanDirection&&(r.scanLeftToRight=!r.scanLeftToRight,r.scanBottomToTop=!r.scanBottomToTop),[e,o]}function Qt(o){var X;const{container:e,dims:t,cellSize:a=4,horizontalJitter:s=!1}=o;e.innerHTML="";const r=document.createElement("div");r.className="ui-root";const c=document.createElement("div");c.className="palette";let g=((X=P.getByName("Sand"))==null?void 0:X.id)??0;const u=m=>{Array.from(c.querySelectorAll(".palette-item.selected")).forEach(d=>{d.classList.remove("selected")}),m.classList.add("selected"),g=Number(m.dataset.cellId)};P.getAll().forEach(m=>{const d=document.createElement("button");d.className="palette-item",d.title=m.name,d.dataset.cellId=m.id.toString();const M=document.createElement("div");M.className="palette-item-icon",M.style.background=m.color(0,0),d.appendChild(M),d.addEventListener("click",()=>u(d)),c.appendChild(d)}),r.appendChild(c);const i=document.createElement("canvas");i.className="simulation-canvas",i.width=t.width,i.height=t.height;const n=i.getContext("2d");if(!n)throw new Error("Failed to get 2D rendering context");n.imageSmoothingEnabled=!1,i.style.width=`${t.width*a}px`,i.style.height=`${t.height*a}px`,r.appendChild(i),e.appendChild(r);let[l,h]=Vt(t);const p=Ut(),f=P.getAll(),b={};f.forEach(m=>{b[m.id]=m});const y=Array.from(new Set(f.map(m=>m.priority))).sort((m,d)=>m-d),A=[];f.forEach(m=>{const d=m.color(0,0),M=Zt(d);A[m.id]=M||[0,0,0]});const I=n.createImageData(t.width,t.height);function O(){var d;[h,l]=Jt(l,h,b,y,s,p);const m=I.data;for(let M=0;M<l.length;M++){const B=l[M],[H,$,G]=A[B],L=M*4;m[L]=H,m[L+1]=$,m[L+2]=G,m[L+3]=B===((d=P.getByName("Air"))==null?void 0:d.id)?0:255}n.putImageData(I,0,0),requestAnimationFrame(O)}requestAnimationFrame(O);let F=!1;const x=m=>{const d=i.getBoundingClientRect(),M=t.width/d.width,B=t.height/d.height,H=Math.floor((m.clientX-d.left)*M),$=Math.floor((m.clientY-d.top)*B);return{x:H,y:$}},z=m=>{const{x:d,y:M}=x(m);d>=0&&d<t.width&&M>=0&&M<t.height&&(l[M*t.width+d]=g)};i.addEventListener("mousedown",m=>{F=!0,z(m)}),i.addEventListener("mousemove",m=>F&&z(m)),window.addEventListener("mouseup",()=>{F=!1})}function Zt(o){let e=o.replace("#","");e.length===3&&(e=e.split("").map(a=>a+a).join(""));const t=parseInt(e,16);return isNaN(t)?null:[t>>16&255,t>>8&255,t&255]}const w=document.getElementById("app");if(!w)throw new Error("App container element not found");Qt({container:w,dims:T,cellSize:4,horizontalJitter:!0});
